# LogBot Bot

**LogBot Bot** - это Telegram-бот, написанный на Kotlin с использованием Spring Boot.

Возможности приложения:

* создание, редактирование и удаление конфигураций
* выбор активных конфигураций
* получение и отправка в чат уведомлений о появлении логов, удовлетворяющих заданному регулярному выражению

Бот имеет следующие особенности:

* логика навигации построена на состояниях. Состояние каждого чата сохраняется в базу данных
* данные, которые должны передаваться между состояниями, сохраняются в кэш
* используется webhook-стратегия для получения обновлений от Telegram
    * при использовании webhook Telegram сам отправляет в бот обновления чатов (через заданный эндпоинт), что
      обеспечивает быстродействие
    * Telegram требует, чтобы webhook-эндпоинт был доступен через HTTPS, но разрешает использовать самоподписанный
      SSL-сертификат. Бот поддерживает сценарий использования такого сертификата
    * безопасность webhook-эндпоинта обеспечивается тем, что он содержит в себе токен бота

Чтобы Telegram работал с ботом, для него необходимо создать аккаунт.

## Создание аккаунта бота в BotFather

1. Начать диалог с ботом [@BotFather](https://t.me/BotFather)
2. Выбрать отображаемое название бота
3. Выбрать username бота. Он должен заканчиваться словом "bot"
4. Сохранить полученный от BotFather токен. Он понадобится для запуска бота
5. Отправить в BotFather команду `/mybots` (или выбрать её в меню)
6. Выбрать созданного бота
7. Зайти в `Bot Settings`
8. Зайти в `Allow Groups?`. Отключить возможность боту находиться в группах (`Turn groups off`) и перейти обратно в
   настройки (`Back to Settings`)
9. Зайти в `Menu button` и нажать `Configure menu button`
10. Отправить URL редактора конфигураций (`logbot-web`). Адрес должен включать в себя HTTPS
11. Отправить отображаемый на кнопке текст (например, слово `Редактор`)
12. Перейти обратно в настройки (`Back to Settings`). Выбрать `Configure Mini App` - `Edit Mini App URL`
13. Отправить URL редактора конфигураций (`logbot-web`). Как и на шаге 10, адрес должен включать в себя HTTPS

## Дополнительные параметры

* `bot.host-url` - URL хоста бота. Необходим Telegram для отправки боту новых сообщений
* `bot.token` - токен бота, выданный [@BotFather](https://t.me/BotFather)
* `bot.cert-path` (_необязательно_) - путь к файлу SSL-сертификата (требуется при использовании самоподписанного
  сертификата)
* `external-services.auth-url` - URL сервиса авторизации
* `external-services.server-url` - URL бэкенда

## Запуск

Запуск осуществляется при помощи команды `./gradlew bootRun`.

Локальный запуск для разработки можно осуществить под профилем `dev`. Тогда в качестве базы данных будет использоваться
H2.

Можно воспользоваться [ngrok.io](https://ngrok.io), чтобы обойтись без SSL-сертификатов. Тогда перед запуском бота
необходимо:

1. Запустить приложение Ngrok
2. Внутри Ngrok вызвать команду `ngrok http <порт_бота>`
3. Задать в качестве `host-url` сгенерированную ссылку из Forwarding